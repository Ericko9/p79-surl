<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shorten Your Links - URL Shortener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <main role="main" class="container mx-auto px-4 max-w-6xl pt-16 md:pt-16">
        <%- include('./partials/navbar', { dashboard: false, shortens: false, about: true, community: false, contributors: false }) -%>
        <!-- Features Section -->
        <div class="mt-7 mb-12 p-6 max-w-6xl mx-auto">
            <!-- Header with Title, Show From, and Search -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-4">
                    <h1 class="text-lg font-semibold text-gray-700">Recent Shorten Links</h1>
                </div>

                <div class="flex items-center gap-3">
                    <!-- Show From Dropdown -->
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-400">Show from</span> <select id="items-per-page" class="bg-transparent px-2 py-1.5 text-sm text-gray-500 focus:outline-none border-none cursor-pointer">
                            <option value="5">1 to 5</option>
                            <option value="8" selected>1 to 8</option>
                            <option value="10">1 to 10</option>
                            <option value="20">1 to 20</option>
                        </select>
                    </div>

                    <!-- Search Box -->
                    <div class="relative">
                        <input 
                            type="text" 
                            id="search-input" 
                            placeholder="Search by link or date" 
                            class="pl-4 pr-10 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 w-64"
                        />
                        <button class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <i class="fas fa-search text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Links Container -->
            <div id="links-container" class="border-t border-gray-200">
                <!-- Loading State -->
                <div id="loading" class="text-center p-10">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-600"></i>
                    <p class="mt-3 text-gray-600">Loading...</p>
                </div>
            </div>

            <!-- Pagination -->
            <div id="pagination-container" class="hidden mt-10 flex justify-end items-center gap-4">
                <div id="page-numbers" class="flex items-center gap-2">
                    </div>
                
                <div class="flex items-center gap-1 ml-2">
                    <button id="prev-btn" class="text-gray-400 hover:text-blue-500 transition disabled:opacity-30">
                        <i class="fas fa-chevron-left text-xs"></i>
                    </button>
                    <button id="next-btn" class="text-gray-400 hover:text-blue-500 transition disabled:opacity-30">
                        <i class="fas fa-chevron-right text-xs"></i>
                    </button>
                    <button class="text-gray-400 hover:text-blue-500 transition ml-1">
                        <i class="fas fa-angle-double-right text-xs"></i>
                    </button>
                    <span id="total-pages-display" class="text-sm text-gray-400 ml-2">72</span>
                </div>
            </div>
        </div>
    </main>
    <%- include('./partials/footer2') -%>

    <%- include('./partials/qrmodal') %>

    <%- include('./partials/editmodal') %>

    <%- include('./partials/deletemodal') %>

</body>
    
<script>
    // --- 1. KONFIGURASI GLOBAL ---
    const API_URL = 'https://surl.jiwamu.de/api/v1/links/my-links';
    const BASE_SHORT_URL = 'https://surl.jiwamu.de/';
    
    let allLinks = [];
    let filteredLinks = [];
    let currentPage = 1;
    let itemsPerPage = 8;
    let currentDeleteId = null;

    const modalEdit = document.getElementById('editModal');
    const modalQR = document.getElementById('qrModal'); 
    const modalDelete = document.getElementById('deleteModal');
    const container = document.getElementById('links-container');

    // --- 2. FUNGSI UTILITAS ---
    function formatDate(dateString) {
        const date = new Date(dateString);
        const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                      'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('Link berhasil disalin!');
        }).catch(err => console.error('Error copying:', err));
    }

    // --- 3. LOGIKA MODAL ---
    function openEditModal(linkData) {
        if (!modalEdit) return;
        document.getElementById('editLinkId').value = linkData.id || '';
        document.getElementById('editCustomKey').value = linkData.short_key || '';
        document.getElementById('editRedirectUri').value = linkData.redirect_uri || '';
        const type = linkData.rules?.expire_type || 'max_click';
        document.getElementById('editRulesType').value = type;
        document.getElementById('editMaxClick').value = linkData.rules?.max_click || 0;
        if (linkData.rules?.expire_date) {
            document.getElementById('editExpireDate').value = linkData.rules.expire_date.split('T')[0];
        }
        document.getElementById('editRulesType').dispatchEvent(new Event('change'));
        modalEdit.classList.replace('hidden', 'flex');
        document.body.style.overflow = 'hidden';
    }

    function openDeleteModal(id) {
        currentDeleteId = id;
        modalDelete.classList.replace('hidden', 'flex');
        document.body.style.overflow = 'hidden';
    }

    function closeDeleteModal() {
        currentDeleteId = null;
        modalDelete.classList.replace('flex', 'hidden');
        document.body.style.overflow = 'auto';
    }

    window.closeModal = () => {
        if (modalEdit) modalEdit.classList.replace('flex', 'hidden');
        if (modalQR) modalQR.classList.replace('flex', 'hidden');
        document.body.style.overflow = 'auto';
    };

    // --- 4. EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        loadLinks();

        document.addEventListener('click', (e) => {
            const dropToggle = e.target.closest('.dropdown-toggle');
            const editBtn = e.target.closest('.btn-trigger-edit');
            const deleteBtn = e.target.closest('.btn-trigger-delete');

            if (dropToggle) {
                e.preventDefault(); e.stopPropagation();
                const menu = dropToggle.nextElementSibling;
                document.querySelectorAll('.dropdown-menu').forEach(m => m !== menu && m.classList.add('hidden'));
                menu.classList.toggle('hidden');
                return;
            }

            if (editBtn) {
                const linkData = allLinks.find(item => item.id === editBtn.dataset.id);
                if (linkData) openEditModal(linkData);
                document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.add('hidden'));
                return;
            }

            if (deleteBtn) {
                openDeleteModal(deleteBtn.dataset.id);
                document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.add('hidden'));
                return;
            }

            if (!e.target.closest('.dropdown-menu')) {
                document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.add('hidden'));
            }

            if (e.target === modalEdit || e.target === modalQR) closeModal();
            if (e.target === modalDelete) closeDeleteModal();
        });

        document.getElementById('editRulesType')?.addEventListener('change', function() {
            document.getElementById('containerMaxClick').classList.toggle('hidden', this.value !== 'max_click');
            document.getElementById('containerExpireDate').classList.toggle('hidden', this.value !== 'expire_date');
        });

        document.getElementById('confirmDeleteBtn')?.addEventListener('click', async () => {
            if (!currentDeleteId) return;
            try {
                const res = await fetch(`${API_URL.replace('/my-links', '')}/${currentDeleteId}/delete`, { method: 'DELETE' });
                const result = await res.json();
                if (result.status) {
                    closeDeleteModal();
                    loadLinks();
                }
            } catch (err) { alert('Gagal menghapus link'); }
        });
    });

    // --- 5. RENDERING LOGIC (SESUAI GAMBAR) ---
    function renderLinks() {
        if (!container) return;
        container.innerHTML = '';
        
        const startIndex = (currentPage - 1) * itemsPerPage;
        const pageLinks = filteredLinks.slice(startIndex, startIndex + itemsPerPage);

        if (pageLinks.length === 0) {
            container.innerHTML = `<div class="text-center p-10 text-gray-500">Tidak ada link ditemukan</div>`;
            return;
        }

        let lastDate = "";
        pageLinks.forEach(link => {
            const currentDate = formatDate(link.created_at);
            
            // Penambahan Label Tanggal (Sesuai Gambar 2)
            if (currentDate !== lastDate) {
                container.innerHTML += `
                    <div class="flex items-center gap-4 my-6">
                        <span class="text-xs font-medium text-gray-400 whitespace-nowrap">${currentDate}</span>
                        <div class="h-[1px] w-full bg-gray-100"></div>
                    </div>`;
                lastDate = currentDate;
            }

            const shortUrl = `${BASE_SHORT_URL}${link.short_key}`;
            container.innerHTML += `
                <div class="group py-4 transition-all">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <a href="${shortUrl}" target="_blank" class="text-blue-600 hover:underline font-medium text-sm">${shortUrl}</a>
                                <button onclick="copyToClipboard('${shortUrl}')" class="text-blue-400 hover:text-blue-600 transition">
                                    <i class="far fa-copy text-sm"></i>
                                </button>
                            </div>
                            <p class="text-[11px] text-gray-400 italic">from : ${link.redirect_uri}</p>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <a href="/analytics/${link.id}" class="w-9 h-9 flex items-center justify-center bg-cyan-50 text-cyan-600 rounded-xl hover:bg-cyan-100 transition">
                                <i class="fas fa-chart-simple text-sm"></i>
                            </a>

                            <button onclick="openQRModal('${link.id}')" class="w-9 h-9 flex items-center justify-center bg-cyan-50 text-cyan-600 rounded-xl hover:bg-cyan-100 transition">
                                <i class="fas fa-qrcode text-sm"></i>
                            </button>

                            <div class="relative">
                                <button class="dropdown-toggle w-9 h-9 flex items-center justify-center text-gray-400 hover:bg-gray-100 rounded-xl transition">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </button>
                                
                                <div class="dropdown-menu hidden absolute left-1/2 -translate-x-1/2 mt-2 bg-white rounded-2xl shadow-xl border border-gray-100 py-1 w-14 z-[999] overflow-hidden">
                                    
                                    <button data-id="${link.id}" class="btn-trigger-edit w-full py-3 flex items-center justify-center hover:bg-blue-50 text-blue-500 transition">
                                        <i class="far fa-edit text-lg"></i>
                                    </button>
                                    
                                    <button data-id="${link.id}" class="btn-trigger-delete w-full py-3 flex items-center justify-center hover:bg-blue-50 text-blue-600 transition border-t border-gray-50">
                                        <i class="far fa-trash-alt text-lg"></i>
                                    </button>
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        });

        document.getElementById('pagination-container')?.classList.toggle('hidden', filteredLinks.length === 0);
        renderPagination();
    }

    // --- FUNGSI SEARCH & PAGINATION (Tetap Sama) ---
    async function loadLinks() {
        try {
            const res = await fetch(API_URL);
            const result = await res.json();
            if (document.getElementById('loading')) document.getElementById('loading').style.display = 'none';
            if (result.status && result.data) {
                allLinks = result.data;
                filteredLinks = [...allLinks];
                renderLinks();
            }
        } catch (err) { console.error('Fetch error:', err); }
    }

    function renderPagination() {
    const totalPages = Math.ceil(filteredLinks.length / itemsPerPage);
    const pageNumbers = document.getElementById('page-numbers');
    if (!pageNumbers) return;
    
    pageNumbers.innerHTML = '';
    
    // Tampilkan teks total halaman di sebelah kanan
    const totalDisplay = document.getElementById('total-pages-display');
    if (totalDisplay) totalDisplay.textContent = totalPages || 1;

    // Loop angka halaman
    for (let i = 1; i <= totalPages; i++) {
        // Hanya tampilkan beberapa angka jika halaman terlalu banyak (Opsional)
        if (i === 1 || i === 2 || i === 3 || i === currentPage) {
            const isActive = i === currentPage;
            const activeClass = isActive 
                ? 'bg-cyan-100 text-cyan-600 font-bold' // Bulat biru muda untuk yang aktif
                : 'text-gray-400 hover:text-gray-600';
                
            pageNumbers.innerHTML += `
                <button onclick="goToPage(${i})" class="w-8 h-8 flex items-center justify-center rounded-full text-sm transition ${activeClass}">
                    ${i}
                </button>
            `;
        }
    }

    // Update status tombol navigasi
    document.getElementById('prev-btn').disabled = currentPage === 1;
    document.getElementById('next-btn').disabled = currentPage === totalPages || totalPages === 0;
}

    function goToPage(page) { currentPage = page; renderLinks(); window.scrollTo({top: 0, behavior: 'smooth'}); }

    function handleSearch() {
        const term = document.getElementById('search-input').value.toLowerCase();
        filteredLinks = allLinks.filter(l => l.short_key.toLowerCase().includes(term) || l.redirect_uri.toLowerCase().includes(term));
        currentPage = 1;
        renderLinks();
    }
</script>
</html>